#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push validation for NeonHub..."

# Check if we're pushing to protected branches
protected_branches="^(main|develop|master)$"
current_branch=$(git rev-parse --abbrev-ref HEAD)

if [[ $current_branch =~ $protected_branches ]]; then
  echo "ğŸ”’ Pushing to protected branch: $current_branch"
  echo "ğŸ” Running comprehensive validation..."
  
  # Run quick quality checks
  echo "1. ğŸ” Running lint check..."
  pnpm lint || {
    echo "âŒ Lint check failed. Please fix linting issues before pushing."
    exit 1
  }
  
  echo "2. ğŸ”§ Running type check..."
  pnpm type-check || {
    echo "âŒ Type check failed. Please fix TypeScript errors before pushing."
    exit 1
  }
  
  echo "3. ğŸ§ª Running tests..."
  pnpm test || {
    echo "âŒ Tests failed. Please ensure all tests pass before pushing."
    exit 1
  }
  
  echo "4. ğŸ—ï¸ Testing build..."
  pnpm build || {
    echo "âŒ Build failed. Please fix build errors before pushing."
    exit 1
  }
  
  echo "âœ… All pre-push checks passed!"
else
  echo "â„¹ï¸ Pushing to feature branch: $current_branch"
  echo "ğŸ” Running basic validation..."
  
  # Run basic checks for feature branches
  pnpm lint --max-warnings=10 || {
    echo "âš ï¸ Lint check has warnings (non-blocking)"
  }
  
  pnpm type-check || {
    echo "âš ï¸ Type check has issues (non-blocking)"
  }
  
  echo "âœ… Basic pre-push checks completed"
fi

echo "ğŸš€ Push validation completed successfully!"
